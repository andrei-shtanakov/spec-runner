# ATP Platform ‚Äî Makefile
# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏

.PHONY: help install dev test lint format docs clean
.PHONY: task-list task-stats task-next task-graph

# === Setup ===

help:  ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

install:  ## –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
	pip install -e ".[dev]"

dev:  ## –ù–∞—Å—Ç—Ä–æ–∏—Ç—å dev –æ–∫—Ä—É–∂–µ–Ω–∏–µ
	pip install -e ".[dev]"
	pre-commit install
	@echo "‚úÖ Dev environment ready"

# === Testing ===

test:  ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
	pytest tests/ -v --cov=atp --cov-report=term-missing

test-unit:  ## –¢–æ–ª—å–∫–æ unit —Ç–µ—Å—Ç—ã
	pytest tests/unit -v

test-integration:  ## –¢–æ–ª—å–∫–æ integration —Ç–µ—Å—Ç—ã
	pytest tests/integration -v

test-e2e:  ## –¢–æ–ª—å–∫–æ e2e —Ç–µ—Å—Ç—ã
	pytest tests/e2e -v

test-fast:  ## –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã (–±–µ–∑ slow)
	pytest tests/ -v -m "not slow"

coverage:  ## –û—Ç—á—ë—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
	pytest tests/ --cov=atp --cov-report=html
	@echo "üìä Coverage report: htmlcov/index.html"

# === Code Quality ===

lint:  ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ (ruff + mypy)
	ruff check atp/
	mypy atp/

format:  ## –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
	ruff format atp/ tests/
	ruff check --fix atp/ tests/

check: lint test  ## –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (lint + test)

# === Task Management ===

task-list:  ## –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–¥–∞—á
	@python task.py list

task-todo:  ## –°–ø–∏—Å–æ–∫ TODO –∑–∞–¥–∞—á
	@python task.py list --status=todo

task-progress:  ## –ó–∞–¥–∞—á–∏ –≤ —Ä–∞–±–æ—Ç–µ
	@python task.py list --status=in_progress

task-stats:  ## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–¥–∞—á
	@python task.py stats

task-next:  ## –°–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã
	@python task.py next

task-graph:  ## –ì—Ä–∞—Ñ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
	@python task.py graph

task-p0:  ## –¢–æ–ª—å–∫–æ P0 –∑–∞–¥–∞—á–∏
	@python task.py list --priority=p0

task-mvp:  ## –ó–∞–¥–∞—á–∏ MVP
	@python task.py list --milestone=mvp

# === Task Workflow ===

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make task-start ID=TASK-001
task-start:  ## –ù–∞—á–∞—Ç—å –∑–∞–¥–∞—á—É (make task-start ID=TASK-001)
	@python task.py start $(ID)

task-done:  ## –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞—á—É (make task-done ID=TASK-001)
	@python task.py done $(ID)

task-show:  ## –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞—á—É (make task-show ID=TASK-001)
	@python task.py show $(ID)

# === Documentation ===

docs:  ## –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
	@echo "üìö Building docs..."
	# mkdocs build –∏–ª–∏ sphinx

docs-serve:  ## –ó–∞–ø—É—Å—Ç–∏—Ç—å docs —Å–µ—Ä–≤–µ—Ä
	# mkdocs serve

# === Build & Release ===

build:  ## –°–æ–±—Ä–∞—Ç—å –ø–∞–∫–µ—Ç
	python -m build

clean:  ## –û—á–∏—Å—Ç–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
	rm -rf build/ dist/ *.egg-info/
	rm -rf .pytest_cache/ .coverage htmlcov/
	rm -rf .mypy_cache/ .ruff_cache/
	find . -type d -name __pycache__ -exec rm -rf {} +

# === Auto Execution (Claude CLI) ===

exec:  ## –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ Claude
	@python executor.py run

exec-task:  ## –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞–¥–∞—á—É (make exec-task ID=TASK-001)
	@python executor.py run --task=$(ID)

exec-all:  ## –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –≥–æ—Ç–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
	@python executor.py run --all

exec-mvp:  ## –í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞—á–∏ MVP
	@python executor.py run --all --milestone=mvp

exec-status:  ## –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
	@python executor.py status

exec-retry:  ## –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–¥–∞—á—É (make exec-retry ID=TASK-001)
	@python executor.py retry $(ID)

exec-logs:  ## –õ–æ–≥–∏ –∑–∞–¥–∞—á–∏ (make exec-logs ID=TASK-001)
	@python executor.py logs $(ID)

exec-reset:  ## –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ executor
	@python executor.py reset

# === CI/CD ===

ci: lint test  ## CI pipeline (–¥–ª—è GitHub Actions)
	@echo "‚úÖ CI passed"

# === Default ===

.DEFAULT_GOAL := help
